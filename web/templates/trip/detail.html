
{% extends "main_hero_1cols.html" %}
{% load cms_tags sekizai_tags disqus_tags %}
{% block title %}
  {{ object.name }}
{% endblock %}

{% block meta_description %}
	{{trip.description }}
{% endblock %}

{% block meta_keywords %}
	{{trip.destination}}, {{trip.type_of_trip}}, Packing, Travel, Bag, Luggage
{% endblock %}

{% block hero_content %}
	<legend id="trip_name">{{trip.name}}</legend>
	<ul class="nav nav-tabs">
		<li class="active"><a href="#pack_list" data-toggle="tab">Pack List</a></li>
	  	<li><a href="#description" data-toggle="tab">Description</a></li>
	  	<li><a href="#members" data-toggle="tab">Members</a></li>
	  	<li><a href="#map" data-toggle="tab">Map</a></li>
	</ul>
{% endblock %}
{% block center_content %}
	<div class="tab-content">
		<div class="tab-pane active" id="pack_list"><!-- Pack List -->
			<div class="span4">
				<div class="well unit-bg">
					<div class="caption">
						<h4>Your Items</h4>
					</div>
					<ul id="items" data-bind="foreach: items">
						<li>
							{% if is_owner%}
							<input type="checkbox" data-bind="checked: is_packed, click: $root.setPacked" />
							<i class="icon-minus-sign" data-bind="click: $root.removeItem" ></i> 
							{% endif %}
							<span data-bind="text: quantity"></span>
							{% if is_owner%}
							<i class="icon-plus-sign" data-bind="click: $root.increaseQuantity" ></i> 
							{% endif %}
							<span data-bind="text: name">
							</span>
						</li>
					</ul>
					{% if is_owner%}
					<hr/>
					<input id="search_items_input" name="search_items_input" class="pull-left"/>
					<i class="icon-plus-sign button add_item_image" id="add_item_image"	class="pull_right"></i>
					<input type="hidden" id="search_item_id" name="search_item_id">		
					{% endif %}
				</div>
			</div><!--span -->

			<div class="span4">
				<div class="well unit-bg">
					{% if is_owner%}
					<div class="caption">
						<h4>Suggested Items</h4>
					</div>
					<ul id="popular_items" data-bind="foreach: popular_items">
						<li>
							<i  class="icon-plus-sign" data-bind="click: $root.moveFromPopularItem"></i> 
							<span data-bind="text: name" />
						</li	>
					</ul>
					{% endif %}
				</div>
			</div><!--span -->

			<div class="span4	">
				<div class="well unit-bg">
					{% disqus_dev %}
					{% disqus_show_comments %}
				</div>
			</div><!--span -->
		</div>
		<div class="tab-pane" id="description"><!-- Description -->
			<div class="span12 unit-bg">
				{{trip.description}}
			</div>
		</div>
		<div class="tab-pane" id="members"><!-- Members -->
			<div class="span6 unit-bg">
				<ul>
				{% for member in trip.members.all%}
					<li>{{member.first_name}} {{member.last_name}}</li>
				{% endfor %}
				</ul>
			</div>
			<div class="span6 unit-bg">
				<ul>
				{% for friend in friends%}
					<li id="add_member">{{friend.user.first_name}} {{friend.user.last_name}} <img src="https://graph.facebook.com/{{friend.uid}}/picture"/></li>
				{% endfor %}
				</ul>
			</div>
		</div>
	</div>
{% endblock %}

{% block scripts %}
<script>

// Class to represent an item
function Item(name, uri, relationsship_id, quantity, is_packed) {
    var self = this;
    self.name = name;
	self.relationship_uri = relationsship_id;
	self.resource_uri = uri;
	self.is_packed = ko.observable(is_packed == "True");
	self.quantity = ko.observable( quantity );

}

// Model holding data for the view
function TripViewModel() {
    var self = this;
	
	self.members = ko.observableArray([
		{% for member in members%}
			new User('{{item.name}}', '/api/v1/item/{{item.id}}/', ''),
		{% endfor %}
		]);
	
	// Populate initial popular items
	self.popular_items = ko.observableArray([	
		{% for item in popular_items%}
			new Item('{{item.name}}', '/api/v1/item/{{item.id}}/', ''),
		{% endfor %}
		]);	
	
	// populate initial items
	self.items = ko.observableArray([	
		{% for item in items%}
				new Item('{{item.item.name}}',
						'/api/v1/item/{{item.item.id}}/', 
						'/api/v1/tripitemrelationship/{{item.id}}/',  
						{{item.quantity}}, '{{item.packed}}'),
		{% endfor %}
		]);
	
	
	// Removes item from item list, if quantity == 0 it is removed completely
	self.removeItem = function(item) {
		if( item.quantity() > 1 ) {
			item.quantity( item.quantity()-1);
			updateItemRelationship( item );
		} else {
			self.items.remove(item);
			self.popular_items.push(item);
			removeItem(item.relationship_uri);
			
		}
	};
	
	// Increase quantity of item 
	self.increaseQuantity = function( item ) {
		item.quantity(item.quantity()+1);
		updateItemRelationship( item );
	}
	
	// Saves the is packed flag to the server
	self.setPacked = function( item ) {
		updateItemRelationship( item );
		return true;
	}
	
	// Saves the item to the server
	self.updateItem = function( item ) {
		updateItemRelationship( item );
	}
	
	// Moves item from popular item to item list
    self.moveFromPopularItem = function(item) { 
		self.popular_items.remove(item);
		item.quantity(1);
		addItem( self, item, '/api/v1/trip/{{trip.id}}/', 1);
	}
}	


	var tripModel = new TripViewModel();
	var tmpName;
	ko.applyBindings( tripModel );
	
		$( "#search_items_input" ).autocomplete({
					source: function( request, response ) {
						$.ajax({
							url: "/api/v1/item/",
							dataType: "jsonp",
							data: {
								name__contains: request.term
							},
							success: function( data ) {
								response( $.map( data.objects, function( item ) {
								return {
									label: item.name,
									value: item.name,
									resource_uri: item.resource_uri	
								}
							}));
							}
						});
					},
					minLength: 2,
					select: function( event, ui ) {
						$('#search_item_id').val(ui.item.resource_uri);
					},
					open: function() {
					
					},
					close: function() {
						
					}
				});

		$("")

		$(".add_item_image").click(function() {
			var element = $(this);
			var item_uri = $('#search_item_id').val();

			if(item_uri == "") {
				var json = new Object();
				var tmpName = $('#search_items_input').val();
				json['name'] = $('#search_items_input').val();
				$.ajax({
					type: "POST",
					url: "/api/v1/item/",
					contentType: "application/json",
					data: JSON.stringify(json),
					success:function(xhr, txt, c){ 
						var json = new Object();
						var url = c.getResponseHeader('location');
					
							var a = document.createElement('a');
							a.href = url;
							var resource = a.pathname + a.search; // /file.php?id=1
							resource_uri = resource; 
							var name = tmpName;
							
							var item = new Item(name, resource_uri, '', 1, false );
							
						addItem(tripModel, item,  '/api/v1/trip/{{trip.id}}/');
					},	
				});
			} else {
				resource_uri = $('#search_item_id').val();
				var name = jQuery.extend({}, $('#search_items_input').val());
				var item = new Item( name, resource_uri, '', 1, false);
				
				addItem( tripModel,item, '/api/v1/trip/{{trip.id}}/');		
			}
			$('#search_items_input').val("");
			return false;
		});
	
		function addMember( context, item, user) {
			var json = new Object()
			json['trip'] = '/api/v1/trip/'+trip.id
			json['user'] = '/api/v1/user/'+user.id
			var uri;
			$.ajax({
				type: "POST",
				url: "/api/v1/tripitemrelationship/",
				contentType: "application/json",
				data: JSON.stringify(json),
				success: function(xhr, txt, c){
					echo(c);
				},	
			});
		}
	
		function addItem( context, item, tripUri ) {
				var json = new Object();
				json['trip'] = tripUri;
				json['item'] = 	item.resource_uri;
				var uri;
				$.ajax({
					type: "POST",
					url: "/api/v1/tripitemrelationship/",
					contentType: "application/json",
					data: JSON.stringify(json),
					success: function(xhr, txt, c){
						url = c.getResponseHeader('location');
						var a = document.createElement('a');
						a.href = url;
						var resource = a.pathname + a.search; // /file.php?id=1
						item.relationship_uri = resource;
						context.items.push( item );
					},	
				});
		}
		
		function removeItem( relationship_uri ) {
				
				$.ajax({
				    type: "DELETE",
				    url: relationship_uri,
					contentType: "application/json",
				
				});		
		}
		
		function updateItemRelationship( item ) {
			var tripItemRelationship = new Object();
			tripItemRelationship['quantity'] = item.quantity();
			tripItemRelationship['packed'] = item.is_packed();
				$.ajax({
					type: "PATCH",
					url: item.relationship_uri,
					contentType: "application/json",
					dataType: "application/json",
					data: JSON.stringify(tripItemRelationship),	
				})
		}
	
		function editTrip( field, value ) {
					var trip = new Object()
					trip[field] = value;
					$.ajax({
						type: "PATCH",
						url: "/api/v1/trip/{{trip.id}}/",
						contentType: "application/json",
						dataType: "application/json",
						data: JSON.stringify(trip),	
					})
					return value;	
		}
		
		{% if is_owner %}
		
		$('#trip_description').editable(function(value, settings){
			return editTrip('description', value );
			
		}, { 
			type: "textarea",
			cssclass: "description_input",
			submit: "Ok",
			cancel: "Cancel"
		});
		
		$('#trip_name').editable(function(value, settings){
			return editTrip('name', value );
		});
		{% endif %}
</script>
{% endblock %}

